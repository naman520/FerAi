<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Real-time Emotion Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; max-width: 800px; margin: 0 auto; }
        #videoContainer { position: relative; display: inline-block; }
        #video { border: 5px solid #ccc; }
        #emotion-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 18px;
        }
        #emotion-chart { width: 100%; height: 200px; margin: 20px 0; }
        #debug-info { margin-top: 10px; font-style: italic; }
        .emotion-feedback { margin-top: 10px; }
        .emotion-feedback button { margin: 0 5px; }
    </style>
</head>
<body>
    <h1>Enhanced Real-time Emotion Detection</h1>
    <div id="videoContainer">
        <video id="video" width="640" height="480" autoplay></video>
        <div id="emotion-overlay"></div>
    </div>
    <canvas id="emotion-chart"></canvas>
    <div id="emotion-chart"></div>
    <div class="emotion-feedback">
        <p>Is the detected emotion correct?</p>
        <button onclick="provideFeedback(true)">Yes</button>
        <button onclick="provideFeedback(false)">No</button>
    </div>
    <div id="debug-info"></div>

    <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('emotion-overlay');
    const debugInfo = document.getElementById('debug-info');
    let chart;

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(err => console.error("Error accessing the camera", err));

    function initChart() {
    const ctx = document.getElementById('emotion-chart').getContext('2d');
    chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Angry', 'Disgust', 'Fear', 'Happy', 'Sad', 'Surprise', 'Neutral'],
                datasets: [{
                    label: 'Emotion Probability',
                    data: [0, 0, 0, 0, 0, 0, 0],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(153, 102, 255, 0.6)',
                        'rgba(255, 159, 64, 0.6)',
                        'rgba(199, 199, 199, 0.6)'
                    ]
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1
                    }
                }
            }
        });
    }

    function detectEmotion() {
        const startTime = performance.now();
        const canvas = document.createElement('canvas');
        canvas.width = 48;
        canvas.height = 48;
        canvas.getContext('2d').drawImage(video, 0, 0, 48, 48);
        
        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('image', blob, 'capture.jpg');

            fetch('http://127.0.0.1:5000/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                updateOverlay(data);
                updateChart(data);
                const endTime = performance.now();
                updateDebugInfo(endTime - startTime);
            })
            .catch(error => {
                console.error('Error:', error);
                debugInfo.textContent = `Error: ${error.message}`;
            });
        }, 'image/jpeg');
    }

    function updateOverlay(data) {
        const topEmotion = Object.entries(data).reduce((a, b) => a[1] > b[1] ? a : b);
        overlay.textContent = `Top Emotion: ${topEmotion[0]} (${(topEmotion[1] * 100).toFixed(2)}%)`;
        video.style.borderColor = getEmotionColor(topEmotion[0]);
    }

    function updateChart(data) {
        chart.data.datasets[0].data = Object.values(data);
        chart.update();
    }

    function updateDebugInfo(processingTime) {
        debugInfo.textContent = `Processing time: ${processingTime.toFixed(2)}ms`;
    }

    function getEmotionColor(emotion) {
        const colors = {
            'Angry': '#ff6384',
            'Disgust': '#4bc0c0',
            'Fear': '#ffce56',
            'Happy': '#36a2eb',
            'Sad': '#9966ff',
            'Surprise': '#ff9f40',
            'Neutral': '#c7c7c7'
        };
        return colors[emotion] || '#cccccc';
    }

    function provideFeedback(isCorrect) {
        // Here you would typically send this feedback to your server
        console.log(`User feedback: Emotion detection ${isCorrect ? 'correct' : 'incorrect'}`);
        alert(`Thank you for your feedback! ${isCorrect ? 'Great!' : 'We\'ll work on improving.'}`);
    }

    video.addEventListener('loadedmetadata', () => {
        initChart();
        setInterval(detectEmotion, 1000); // Detect emotion every second
    });
    </script>
</body>
</html>